INTSourceChangelist:2735872
Availability:Public
Title:フォリッジ インスタンス化メッシュ
Crumbs:%ROOT%, Engine
Description:フォリッジまたは他のグラウンド カバー エフェクトとして使用するために、他のジオメトリのサーフェスでインスタンス化されたメッシュをレンダリングするシステム
Version:4.9
SkillLevel:Intermediate
parent:Engine
order:9

[VAR:Topic]
[OBJECT:Topic]
	[PARAM:image]
		![%Engine/Foliage:title%](Engine/Foliage/foliage_topic.png)
	[/PARAM]
	[PARAM:icon]
		![](%ROOT%/foliage_icon.png)(convert:false)
	[/PARAM]
	[PARAM:title]
		%Engine/Foliage:title%
	[/PARAM]
	[PARAM:description]
		%Engine/Foliage:description%
	[/PARAM]
	[PARAM:path]
		[RELATIVE:Engine/Foliage]
	[/PARAM]
[/OBJECT]
[/VAR]

[VAR:TopicCompact]
[OBJECT:TopicCompact]
	[PARAM:image]
		![%Engine/Foliage:title%](Engine/Foliage/foliage_topic.png)
	[/PARAM]
	[PARAM:icon]
		![](%ROOT%/foliage_icon.png)(convert:false)
	[/PARAM]
	[PARAM:title]
		%Engine/Foliage:title%
	[/PARAM]
	[PARAM:description]
		%Engine/Foliage:description%
	[/PARAM]
	[PARAM:path]
		[RELATIVE:Engine/Foliage]
	[/PARAM]
[/OBJECT]
[/VAR]

[REGION:header_img]
![Foliage Tool](Foliage_Banner.png)(w:900)
[/REGION]

[TOC(start:2 end:3)]

[EXCERPT:Intro]

フォリッジ システムによって、ランドスケープ アクタ上、他のスタティック メッシュ アクタ、BSP でスタティック メッシュ群をすばやくペイントまたは消去することができるようになります。 
これらのメッシュは、ハードウェア インスタンシングを使用してレンダリングされるバッチに自動的に統合されます。つまり、たった 1 度のドローコールで多数のインスタンスをレンダリングすることができるということです。

[/EXCERPT:Intro]

フォリッジ ツールの実施例を見るには、 [](Resources\ContentExamples\Landscapes) の [フォリッジ](Resources\ContentExamples\Landscapes\1_3) にあるコンテンツ サンプルをご覧ください。

##フォリッジ編集モード

フォリッジ ツールを使用するには、アンリアル エディタの左上隅にある **[Modes]** パネルの [Foliage] ボタン (**Shift+4**) をクリックします。 

![FoliageMode.png](FoliageMode.png)
 
**[Modes]** パネルに [Foliage Edit Mode] ウィンドウが表示されます。

![FoliageWindowInitial.png](FoliageWindowInitial.png)


##メッシュ リスト

メッシュ リストはフォリッジの配置時に使用するスタティックメッシュのエリアです。 
スタティックメッシュをメッシュ リストに追加するには、コンテンツ ブラウザからスタティックメッシュを **Drop Foliage Here (フォリッジをここへドラッグ)** と表示されている領域にドラッグします。

![](Foliage_TextBar.png)

[REGION:tip]
正しいアクタ タイプを追加しようとする場合のみ、フォリッジ タイプが黄色く表示されます。黄色く表示されない場合は、追加することはできません。
[/REGION]

フォリッジとして使用しているスタティックメッシュのプロパティを調整するには、まずメッシュ リストからスタティックメッシュを選びます。次に、フォリッジ右下角にある小さな **虫眼鏡** のアイコンを押して、選択したスタティックメッシュの詳細を展開します。 

![](Expose_Instanc_Options.png)

アイコンを押すと、以下のような画面が表示されます。

![](Foliage_Mesh_Options.png)


###メッシュ リストでフォリッジ メッシュを選択する

メッシュ リストのフォリッジ メッシュは、リストのメッシュにマウスを当てて四角の左上のチェックマーク ボックスにチェックを入れる、または外すことで、有効と無効の切り替えができます。 

![](Foliage_Selecting_Meshes.png)

メッシュ リストでそれらをクリックしても、フォリッジ メッシュを選択することができます。 
選択するとボックスがオレンジで囲まれて、以下のオプション パネルで各種プロパティの調整が可能になります。 

![](Foliage_Selected_Meshes.png)

##ブラシの設定

![](Foliage_Brush_Settings.png)

**メッシュ** リストの上に、メッシュ編集ツールが現在選択中のフォリッジ ツールに関連するプロパティを表示します。(全ての設定にそれぞれフォリッジ ツールが付いているわけではありません。)

| アイテム | 説明 |
| ---- | ----------- |
| **Brush Size** | ブラシのサイズをアンリアル単位で決定します。 | 
| **Paint Density** |  [INCLUDE:Engine/Foliage#PaintDensity] |
| **Erase Density** |  [INCLUDE:Engine/Foliage#EraseDensity] |

**[Landscape (ランドスケープ)]**、**[Static Meshes (スタティックメッシュ)]**、**[BSP (バイナリ空間分割)]**、**[Translucent (透過)]** のチェックボックスは、ツール使用時に設置するフォリッジ メッシュのアクタ タイプを決定するためのものです。 
ここにチェックを入れると、アクタ タイプ上でツールを使用した時にフォリッジ メッシュが追加されることを表します。
チェックが外れていると、そのアクタ タイプ上にはフォリッジ メッシュが追加されないことを表します。

<!---
[EXCERPT:PaintDensity]
**マウスの左ボタン** を使ってインスタンス追加する際の目標密度です。
* この範囲は、0 から 1 までです。値が 1 の場合は、各メッシュの Mesh プロパティ (下記参照) にある最大密度でメッシュ インスタンスをペイントします。
* ブラシ内にあるメッシュの密度がすでにこの値を超えている場合は、メッシュがまったく追加されません。
[/EXCERPT:PaintDensity]
--->


<!---
[EXCERPT:EraseDensity]
**Ctrl+Shift+ クリック** でインスタンスを消去する場合に狙うターゲット密度です。
* この値の範囲は 0 から 1 までです。値が 0 の場合は、メッシュがまったく表示されません。この目標となる消去密度よりもメッシュが少ない場合は、メッシュがそれ以上消去されることはありません。 
* この設定項目によって、すべてのインスタンスを完全に除去することなく、すでにペイントされているメッシュを間引くことができます。
[/EXCERPT:EraseDensity]
--->

<!---
[EXCERPT:Filter]
どのような種類のオブジェクト上にインスタンスを配置するか制御できます。 
* フィルタタイプに適合しないオブジェクト上では、フォリッジ球体ブラシが消えるため、ご注意ください。 
* また、アクティブなストリーミング レベルのオブジェクト上でしかペイントできませんので、ご注意ください。
[/EXCERPT:Filter]
--->


[REGION:note]
また、タブレットの圧力感受性がサポートされています。ペンの圧力によって、追加 / 削除されるフォリッジ メッシュ インスタンスの数を制御することができます (これは、他のパラメータがすべて考慮された上で実行されます)。
[/REGION]

## フォリッジ ツール
[Foliage] ウインドウの上部にあるツールバーから適切なボタンを選択すると、5 つのツールを使用することができます。  

| アイテム | 説明 |
| --- | --- |
| ![Paint Tool](ToolPaint.png) | **Paint ツール** は、フォリッジ インスタンスをワールドに追加したり、ワールドから削除するために使います。 |
| ![Reapply Tool](ToolReapply.png) | **Reapply ツール** は、既にワールドにペイントされたインスタンスのパラメータの変更に使用します。 |
| ![Select Tool](ToolSelect.png) | **Selection ツール** は、移動、削除などのために個々のインスタンスを選択するために使用します。 |
| ![Paint Select Tool](ToolPaintSelect.png) | **Lasso ツール** は、ペイントブラシを使って多数のインスタンスを選択するためのツールです。 |
| ![Fill Tool](ToolFill.png) | **Fill ツール** は、Paint ツールを使って配置するメッシュ数を決定するためのツールです。 |


### Paint ツール

![Paint Tool](ToolPaint.png)

Paint ツールは フォリッジ編集モードのデフォルトのツールです。レベル内のメッシュ リストのスタティック メッシュのインスタンスをペイントするためのツールです。
フォリッジ編集モードがアクティブな場合、透明な球体ブラシがレベル内で描画され、フォリッジ ブラシが機能する場所を示します。
以下の画像は、フォリッジのペイント ブラシのサンプルです。

![](Foliage_Paint_Tool_Gimzo.png)

**フォリッジをブラシの領域に追加する方法**  
* **マウスの左ボタン** を押しながら、フォリッジを追加したい場所をクリックします。メッシュ リストで現在選択されている全てのメッシュが、それぞれの現在のパラメータと設定に合わせて追加されます。

メッシュをペイントする場合、エンジンは、視線に平行に多数のライントレースを球体内部で実行します。つまり、球体内部に見えるサーフェスはどこもフォリッジ インスタンスの潜在的なターゲットになり得るということになります。

**ブラシの領域からフォリッジを消去する方法**  
* **マウスの左ボタン + Shift** を押しながら、削除したいフォリッジの場所をクリックします。メッシュ リスト内で現在選択中のメッシュのインスタンスのみが削除されることにご注意ください。


### ペイントの設定項目

メッシュ リスト内にある各メッシュには、選択したスタティックメッシュのペイント時のインスタンスの配置、スケール、回転を制御するプロパティが多数あります。 
これらのプロパティは、メッシュ リストに欲しいスタティックメッシュを 1 つ以上選択してアクセスし、以下のプロパティを調整します

![Paint Settings](Foliage_PaintSettings.png)

各セクションの使用目的の概要です。

| **プロパティ** | **説明** |
| --- | --- |
| **Mesh** | 使用するスタティックメッシュのタイプを入力します。 |
| **Painting** | フォリッジ メッシュ間の最短距離、メッシュ追加時の密度、フォリッジ メッシュをスケールするか否かなどのプロパティを調整します。|
| **Placement** | レベルにペイントする際のフォリッジ メッシュの配置を制御します。|
| **Instance Settings** | このインスタンスのビヘイビアを調整し、コンテンツブラウザのスタティックメッシュから派生したプロパティを使用しないようにします。|


### Reapply (再適用) ツール

![Reapply Tool](ToolReapply.png)

ワールド内に配置済みのフォリッジ メッシュのパラメータを選んで変更することができるツールです。 
Reapply ツールを有効にしてこれらのフォリッジ メッシュ上をペイントすると、メッシュ リストで選択されたフォリッジ メッシュが更新されて、Reapply ツールで作成された変更が反映されます。

![](Foliage_Reapply.png)

チェックボックスにチェックを入れると、既存のインスタンスの上をブラシでペイントしながら、そのチェックボックスに対応するパラメータを再適用することができます。 
ほとんどの設定項目は、Paint ツールの場合と同様に使用できますが、相違点もいくつかあります。

| アイテム | 説明 |
| --- | --- |
| **Mesh** | 使用するスタティックメッシュのタイプを入力します。 |
| **Painting** | フォリッジ メッシュをレベルに追加する時に何が起こるかをオーバーライドします。 |
| **Placement** | レベル内でのフォリッジ メッシュの配置の仕方をオーバーライドします。 |



### Select (選択) ツール
![Select Tool](ToolSelect.png)

Select ツールが有効になっている場合は、個々のインスタンスをクリックすることによって選択が可能になります。 
レベル内でフォリッジ メッシュをクリックしながら **Ctrl** ボタンを押すと、一度に複数のフォリッジ メッシュを選択することができます。

![Selected Instance](Foliage_SelectInstance.png)

インスタンスを選択したら、それらに対して以下のアクションを実行することができます。

| **動作** | **結果** |
| --- | --- |
| **ウィジェット軸をドラッグする** | 選択したインスタンスはウィジェットに従って移動し、ウィジェット モードに応じて回転またはスケールします。 |
| **Alt キーを押下しながらウィジェットの軸をドラッグする** | 選択されているインスタンスがまず複製され、さらに、ウィジェットに従って動きます。 |
| **Dlete キー** | 選択されているインスタンスが削除されます。 |
| **End キー** | 選択されているインスタンスが、フロアにスナップしようとします。元々この設定項目が有効な状態で配置されている場合は、インスタンスが法線に平行になります。

各種 **[Select (選択)]** ボタンを使って、すべての Foliage Mesh アクタを選択したり、無効のフォリッジ メッシュを選択したり、選択を解除することができます。

![](Foliage_Select_Options.png)

### Lasso (投げ縄) ツール

![Lasso Tool](ToolPaintSelect.png)

Lasso ツールによって、Paint ツールでも使用される球体ブラシを使って、多数あるいは少数のフォリッジメッシュを同時に選択することができます。 
フィルタリング設定を使えば、特定のオブジェクトに設置されるフォリッジメッシュが選択されないようになります。 
フォリッジメッシュを選択するには、マウスの右ボタンを押しながらシーンの周辺でマウスを動かします。
フォリッジメッシュの選択を解除するには、ペイント中に **Shift** キーを長押しします。 
選択が完了すると、通常の選択ツールに切り替えて、フォリッジメッシュの複製、移動、削除などの操作を行うことができます。

![Lasso Tool](Foliage_Lasso.png)

### Fill (塗りつぶし) ツール

![Fill Tool](ToolFill.png)

レベル内のスタティック メッシュ アクタ全体をカバーするために使用するツールです。 
Paint ツールと非常によく似ていますが、決定的な違いは一度のクリックでフォリッジ内のアクタ全体をカバーできる点です。
Fill ツールを使うには、フォリッジでカバーしたいスタティックメッシュ上で **マウスの左ボタン** をクリックします。 
マウスをクリックした分だけ、フォリッジが追加されます。
フォリッジを取り除くには、**Shift** キーを押しながら **マウスの左ボタン** でフォリッジを取り除きたいスタティックメッシュをクリックします。

![Foliage Tool](Foliage_Fill.png)

[region:tip]
Fill ツールで消したいフォリッジメッシュを選べない場合は、追加したフォリッジメッシュではなく設置したアクタ上をクリックしていることを確認してください。
[/region]


カリング

フォリッジ インスタンスがクラスターとして単一のドローコールでレンダリングされるため、各クラスターは、オクルージョンに基づいてレンダリングの可否が決定されます。**End Cull Distance** パラメータに値が設定されていると、この距離を超えてもクラスターがカリングされます。ただし、クラスター全体が範囲外になると、メッシュのグループが突然消滅してしまうことになります。

**Start Cull Distance** パラメータを追加し、マテリアルを正しく設定すればこの現象を緩和することができます。頂点シェーダーにおいて、インスタンス毎の係数が計算されます。係数は、距離の始点で 1.0 から始まり、終点で 0.0 となります。PerInstanceFadeAmount ノードを使用することでマテリアル内でアクセスできます。この係数をオパシティまたはマスクの値と接続することによって、インスタンスが **Cull Distance End** に達する前にフェードアウトさせ、レンダリングから除外できます。

次のサンプルマテリアルでは、フェード係数によってマテリアルのマスクが乗じられています。その結果、フォリッジ メッシュの葉が、完全に消えるまで間引かれていきます。

![Culling Material Example](Foliage_MaterialSetup.png)


<!-----
![Culling Material Example](CullingMaterial.png)(w:752 h:378)
---->

## スタティック メッシュの設定

スタティックメッシュに対するフォリッジ関連オプションの設定を、フォリッジ ツールではなく **スタティックメッシュ エディタ** に設定できます。

**スタティックメッシュ エディタ**、**[Details (詳細)]** パネル、**[Static Mesh Settings (スタティックメッシュ設定)]** セクションには、 **[Foliage Default Settings (フォリッジのデフォルト設定)]** オプションがあります。デフォルトでは **None** に設定されています。ドロップダウンの矢印をクリックすれば、 **InstancedFoliageSettings** を選択でき、Foliage ツールでスタティック メッシュの使用を適用できる設定のサブ領域を開くことができます。これらの設定は、Foliage ツールの [Show Painting Settings (ペイント設定を表示)] と [Show Instance Settings (インスタンス設定の表示)] の設定をミラーします。

![Static Mesh Editor Foliage Settings](Foliage_StaticMeshEditor.png)

### LOD

スタティック メッシュの LOD はフォリッジでサポートされています。以下は注意事項です。

* スタティック メッシュは Elements 配列への入力が 1 つだけになっていることを確認してください (LOD0 で表示可能)。
* すべての LOD レベル間で光源とシャドウマップが共有されているため、全 LOD で同一のアンラッピングが使用される必要があります。
* 現在のところ、インスタンスの全クラスタが、 LOD を同時に変更します。将来、インスタンスごとに距離ベースのフェーディングをサポートする可能性があります。



### ライティング

各メッシュインスタンスは、それ自身のシャドウまたはライトマップ (またはその両方) が Lightmass によって生成されます。これらは、事前計算された各バッチについて、ともにタイル処理されます。事前計算された光源処理をインスタンス化したフォリッジで正しく機能させるために、スタティックメッシュの設定項目をいくつか確認します。インスタンス化されたメッシュ用にシャドウマップを生成する場合、Lightmass はより厳格です。不適切な設定を行うと、光源処理を再ビルドした後にメッシュが黒くなる場合があります。


* **Light Map Coordinate Index (ライトマップ座標インデックス)** - ユニークな UV ラッピングを有する有効な UV チャンネルに設定されなければなりません。スタティックメッシュ エディタの **Generate Unique UVs (一意のUV を生成)** は、 **[Window]** メニューから使用することができ、ユニークなラッピングをすばやく作成することができる機能です。
* **Lightmap Resolution (ライトマップ解像度)** - この値を充分に小さくすることによって、 (デフォルトでは 100 である) 単一のクラスター内にあるインスタンスのための全シャドウマップが、最大テクスチャ解像度 (4094x4096) を超えることなくタイル処理されるようにしなければなりません。


[PUBLISH:Licensee]


### コンソール上でのインスタンス設定

Xbox360 や PS3 といったコンソール上でのハードウェア インスタンス化は、PC の場合と少し異なる動作をします。 1 回のドローコールで複数のインスタンスをレンダリングするには、スタティック メッシュのインデックス バッファ データを複製する必要があります。スタティック メッシュには、 **Console Preallocate Instance Count (コンソール事前割り当てインスタンス数)** という設定項目があります。この値を使って、一回のドローコールでレンダリングされるべきインスタンスの事前割り当て数を設定することができます。

たとえば、フォリッジメッシュにトライアングルが 100 個ある場合、通常のスタティックメッシュとしてレンダリングすべき頂点インデックスは 300 個 です (トライアングル 1 個につき 3 個の頂点インデックス)。頂点インデックス 1 個につき 2 バイトであるため、 600 バイトのデータがスタティックメッシュのために格納されていることになります。 

フォリッジとして、このメッシュのインスタンスを 1 回のドローコールで最大 20 個までレンダリングする場合は、 ConsolePreallocateInstanceCount を 20 にセットします。これにより、300 個のインデックスの 20 倍の複製値が格納されます。すなわち、このスタティックメッシュのインデックスに必要な合計メモリは 12,000 バイト (20 X 300 X 2) まで増えることになります。

レベル内に配置されるインスタンスの数にかかわりなく、このスタティックメッシュのためのオーバーヘッドは 1 度しか生じません。データを事前割り当てするだけで、スタティックメッシュの最大 20 個のインスタンス (2000 個のトライアングル) を 1 度のドローコールで望む時にレンダリングすることができるようになります。 

ConsolePreallocateInstanceCount が、クラスタ内でレンダリングする必要があるインスタンスの数 (前述の Instances Per Cluster 設定値) に不十分な場合は、エンジンが自動的に複数のドローコールを発行します。 

1 回のドローコールでかなり多くのトライアングルがレンダリングされるため、コンソール側ではドローコールのコストは相対的に低くなっています。そのため、メモリを使用して 1 回のドローコールでより多くのインスタンスを事前割り当てしても、著しいパフォーマンスの向上が見られないことになります。

したがって、フォリッジに使用されるスタティックメッシュのための ConsolePreallocateInstanceCount には、(インスタンス内のトライアングル数を考慮に入れて) コンソールの GPU をビジーにする数を設定すべきです。設定値が小さすぎると、コンソールの GPU が個々のドローコールを待ってアイドリングの状態となりますし、大きすぎるとパフォーマンスはさほど向上せずにメモリだけが浪費されてしまいます。
[/PUBLISH:Licensee]

 




